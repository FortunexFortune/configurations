#######################################
## Aliases
######################################
alias k='kubectl'   # my alias
po                  # pods
deploy              # deployment
svc                 # service
ns                  # namespace
netpol              # ntetowk policy
pv                  # persistent volume
pvc                 # persistent volume claims
sa                  # service accounts
rs                  # replicaset
cm                  # configmaps
ep                  # endpoints
no                  # nodes
ds                  # daemonsets

# https://kubernetes.io/docs/reference/kubectl/overview/


#######################################
## System
######################################
kubectl get all                                        # returns all objects

kubectl explain <object>                               # Explain resource (help)
kubectl explain persistentvolumes.spec.hostPath        # Explain resource (help)

sudo systemctl status kubelet                             # check status of the service

kubectl create -f .                                       # create all objects in manifets 
kubectl create -f <file.yaml>                             # create k8 object
kubectl create -f <file.yaml>  --namespace=dev            # create object within namesapce
kubectl apply -f o.yam  -n=kube-system                          # create object within namesapce

kubectl get componentstatus                 # returns compoenets status
kubectl cluster-info                        # returns info on where the master and DNS is running
kubectl config view                         # returns brief configuration of your cluster
kubectl api-resources -o wide               # get all resource avaible on your cluster


#######################################
# Pods
######################################

kubectl get pods                            # returns running pods
kubectl get pods -o wide                    # returns ip address of your pods
kubectl get pods -n <name>                  # get pods belonging to a namespace
kubectl get pods --namespeces=<name>        # get pods belonging to a namespace
kubectl get pods --all-namespeces           # get pods across all namespaces
kubectl get pods --all-namespeces -o wide   # get pods across all namespaces with more details

kubectl describe pods
kubectl describe pod nginx
kubectl delete pod nginx
kubectl describe pods  --all-namespaces     # get Information about pods across all name spaces

kubectl get pods  --show-labels             # returns pods and their labels
kubectl get pods --selector key=value       # returns pods with specfic labels
kubectl get pods  -l key=value,key2=value2  # returns pods with specfic labels


kubectl get pods/<podname> -o yaml          # return yaml of a pod state

kubectl edit pod <podName>                  # k8 updates the pod and updates it in real time

#######################################
## Clustering and Nodes
######################################

kubectl get nodes                   # Get a list of nodes
kubectl describe nodes              # get Information about nodes
kubectl describe node $node_name    # Get more information about a specific node

#######################################
## Deployments
######################################

kubectl get deployments                         # returns your deployments
kubectl get deployment <name> -o yaml           # returns the complete yaml of the deployment (COMPLETE)

kubectl describe deployment nginx-deployment    # return more info related to the deployment
kubectl delete deployment nginx                 # delete deployments

kubectl rollout history deployment/<name>   # return history of rollout
kubcetl rollout status deployment/<name>    # return staus of rollout
kubectl rollout undo deployment/<name>      # roll bacl to previous deployment version

#######################################
## namespaces
######################################

kubectl get namespaces                               # return all cluster namespaces
kubectl get <object> --namespeces=<name>             # get object belonging to a namespace
kubectl get <object> -n my-ns                        # get object belonging to a namespace
kubectl  get <object>  --all-namespaces              # get all object belonging to a namespace
kubectl create ns my-ns                              # Create a new namespace named my-ns

kubectl create -f <file.yaml>  --namespace=dev       # create k8 object within specific namesapce

kubectl config set-context $(kubectl config current-context) --namespace=dev  # change workspace scope

kubectl get ns --no-headers     # returns namespaces without title row

#######################################
## ReplicaSet
######################################
kubectl get replicaset
kubectl get replicationController

kube√ßtl replace -f replicaset-definition.yml              # after updating replica file, us this to update the object
kubectl scale --replicas=6 -f replicaset-definition.yml   # scales replica, does not odify file content
kubectl scale --replicas=6 replicaset myapp-replicaset    # scales replica, does not odify file content

#######################################
## DeamonSet
######################################
kubectl get daemonsets 
kubectl describe daemonsets 


#######################################
## Services
######################################
# You can use "svc" or "service"

kubectl  get svc                             # returns  list of services in the cluster.
kubectl  get service                         # returns  list of services in the cluster.
kubectl  get services  --all-namespaces      # get informtiaon about services across all name spaces

kubectl describe services  --all-namespaces
kubectl delete svc nginx-service             # deletes service

kubectl get services kubeserve2 -o yaml      # gets yaml of the service

kubectl get services -w                      # Watch as an external port is created for a service
kubectl get endpoints                        # View the list of endpoints in your cluster that get created with a service
kubectl get gp <serviceName>                 # Vew service endpoint

kubectl get endpoints
kubectl get endpoints kube-scheduler -n kube-system  -o yaml
kubectl get endpoints kube-controller-manager  -n kube-system  -o yaml

#######################################
## Configmap
######################################

kubectl get configmaps       # return configs
kubectl describe configmaps   # describes configmaps  

kubectl create configmap
kubectl create configmap <name> --from-literal=APP_COLOR=blue                               # create config map with key value
kubectl create configmap <name> --from-literal=APP_COLOR=blue --from-literal=APP_MODE=lazy  # create config map with keys/values

#######################################
## Secrets
######################################

kubectl get secret
kubectl describe secret
kubectl get secret <name> -o yaml       # ideal to see values of secret's keys
echo -n "data" | bas64                  # enconde value
echo -n "enconded" | base64 --decode    # decode value

kubectl create secret generic <name> --from-literal=DB_PASSWORD=pass   
kubectl create secret generic <name> --from-literal=DB_PASSWORD=pass  --from-literal=SERVER_PASS=pass 
kubectl create secret generic <name> --from-file=filePath
kubectl create secret generic <name> --from-file=./username.txt --from-file=./password.txt

kubectl get secret <name> -o yaml 



#######################################
## ingress Service
######################################

kubectl edit ingress            # Edit the ingress rules:
kubectl describe ingress        # View the existing ingress rules:

#######################################
## Labels
######################################
# applied at the pod level

kubectl get pods  --show-labels             # returns pods with their label
kubectl get pods -l env                     # returns pods with specific label
kubectl get pods --selector key=value       # returns pods with specfic labels


kubectl get pods -l env=dev         # returns pods with label key and value
kubectl get pods --selector bu=finance  # returns pods with label key and value
kubectl get all --selector bu=finance  # returns pods with label key and value

kubectl get pod -l env=prod,bu=finance,tier=frontend



kubectl label node chadcrowell1c.mylabserver.com availability-zone=zone1

kubectl label pods <name> key=value         # apply a new label to a set of labels 
kubectl label pods <name> env=pod          # apply label to a pod

#######################################
## Annotations
######################################
# applied at the obejct  level 

kubectl annotate deployment  <deployment_Name> mycompany.com/someannotation="chad"
kubectl get pods --field-selector status.phase=Running

#######################################
## Selector
######################################

kubectl get <object> --selector env=dev

kubectl get pods --selector env=dev
kubectl get pods --selector bu=finance
kubectl get all --selector env=prod,bu=finance,tier=frontend
kubectl get all --selector env=prod




#######################################
## Taints
######################################
kubectl taint nodes <nodename> key=value:taint=effect # Taint a node
kubectl taint nodes node1 key:NoSchedule-             # unTaine a node

kubectl taint nodes node01 spray=mortein:NoSchedule --overwrite # overwirte value of taint key value

kubectl taint nodes master node-role.kubernetes.io/master:NoSchedule- # Remove taint from node

#######################################
## logs
######################################

kubectl logs <podName> 
kubectl logs -f <podName> <containerName> # used when you have multiple containers in a pod


#######################################
## Stats
######################################

# Installing metric server
git clone https://github.com/kodekloudhub/kubernetes-metrics-server.git
kubectl apply -f # withing the firectory

kubectl top node  # get stats of cluster nodes -Only works if you have isntalled metric server
kubectl top pod   # get stats of cluster pod -Only works if you have isntalled metric server

#######################################
## ServiceAccount
######################################

kubectl get serviceaccounts
kubectl get serviceaccounts/build-robot -o yaml   # get servie account yaml

#######################################
## csr
######################################

kubectl get CertificateSigningRequest
kubectl get csr

kubectl certificate approve <csr_name>


#######################################
## Maintainance
######################################

kubectl drain <nodeName>      # Pods are gracefully terminated from a node and recreated on another, also marks node as unsheduable
kubectl uncordon <nodeName>   # Marks node as scheduable
kubectl cordon <nodeName>     # Marks node as unscheduable, however old pods still remain on the node

kubectl drain node01 --ignore-daemonsets
kubectl drain node02 --ignore-daemonsets --force

#######################################
## ETCD
######################################
ETCDCTL_API=3 etcdctl snapshot save -h 

ETCDCTL_API=3 etcdctl snapshot status -h 

ETCDCTL_API=3 etcdctl snapshot restore -h 



#######################################
## OneLiners
######################################
https://kodekloud.com/courses/539883/lectures/10503265

--Pod
kubectl run nginx --image nginx
kubectl run nginx --image=nginx --dry-run=client -o yaml  

--Deployment
kubectl create deployment nginx --image=nginx 
kubectl create deployment --image=nginx nginx --dry-run -o yaml
kubectl create deployment --image=nginx nginx --dry-run=client -o yaml > nginx-deployment.yaml

-- Generate Deployment with 4 Replicas
kubectl create deployment nginx --image=nginx
kubectl scale deployment nginx --replicas=4

-- service
kubectl expose pod redis --port=6379 --name redis-service --dry-run=client -o yaml
kubectl expose pod nginx --port=80 --name nginx-service --dry-run=client -o yaml


kubectl create service clusterip redis --tcp=6379:6379 --dry-run=client -o yaml
kubectl create service nodeport nginx --tcp=80:80 --node-port=30080 --dry-run=client -o yaml



# 5) Create a service, and verify connectivity on the node port.
kubectl expose deployment nginx --port 80 --type NodePort

# 3)  Use port forwarding to extend port 80 to 8081, and verify access to the pod directly.
kubectl port-forward [pod_name] 8081:80 # this session must be left open

# 4)  Execute a command directly on a pod.
kubectl exec -it <pod_name> -- nginx -v

# Busybox
kubectl exec busybox -- curl <IP:80>  # Runnin the curl comand from the busybox pod


# 5) Scale deployment replicas
kubectl scale deployment/kubeserve2 --replicas=2


============== Kubernetes MicroServices ==============
cd ~/
git clone https://github.com/linuxacademy/robot-shop.git
kubectl create namespace robot-shop                             # Create a namespace
kubectl -n robot-shop create -f ~/robot-shop/K8s/descriptors/   # deploy app objects using the deployment descriptors from the repo
kubectl get pods -n robot-shop -w                               # -w gives the ability to watch ral time creation of the pods
http://$kube_server_public_ip:30080                             # access the application via the kubernetes master ip

https://github.com/linuxacademy/robot-shop/tree/master/K8s/descriptors

##########################
## Extra
##########################

kubectl get secrets # kubectl get secrets


kubectl get endpoints kube-scheduler -n kube-system -o yaml



# Create a pod instead of a deployment
# --dry-run simulaate the execution
# --restart=Never makes sure this is a pod and not a deployment
kubectl run redis --image=redis --restart=Never --dry-run -o yaml > pod.yaml




# Updating K8s resources

kubectl get po/<name> -o yaml > o.yaml
kubectl delete po/<name>
kubectl apply -f o.yaml





=====================================
== Manifests
=====================================

# certificateSigningRequests
https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/
