======================================================
= Tables
======================================================
https://www.thegeekstuff.com/2011/01/iptables-fundamentals/


Filter 

INPUT chain – Incoming to firewall. For packets coming to the local server.
OUTPUT chain – Outgoing from firewall. For packets generated locally and going out of the local server.
FORWARD chain - Packet for another NIC on the local server. For packets routed through the local server.

NAT 

PREROUTING chain – Alters packets before routing. i.e Packet translation happens immediately after the packet comes to the system (and before routing).
POSTROUTING chain – Alters packets after routing. i.e Packet translation happens when the packets are leaving the system.
OUTPUT chain – NAT for locally generated packets on the firewall.


Mangle 

PREROUTING chain
OUTPUT chain
FORWARD chain
INPUT chain
POSTROUTING chain


Raw 

PREROUTING chain
OUTPUT chain

======================================================
= Commands 
======================================================

# Generic


iptables -A INPUT -p tcp --dport 80 -j DROP                                 # block  https request, frome everywhere 

iptables -t filter -A INPUT -p icmp --icmp-type echo-request -j DROP        # bock icmp requests, more specifically echo requests

iptables -t filter -A OUTPUT -p tcp --dport 80 -d www.ubuntu.com -j DROP    # block outing request to ubuntu domain
iptables -t filter -A OUTPUT -p tcp --dport 443 -d www.ubuntu.com -j DROP   # # block outing request to ubuntu domain


# LIST
iptables -L                   # List filter table (default table)
iptables -nvL                 # Verbose print out all active iptables rules
                              # v --> versbose, show interface name, packet and bytes quantity 
                              # n --> ip adress and ports will be printed  numerically 
            
                              
iptables -t filter -L         # listing the filter table of all chains (INPUT, OUTPUT and FORWARD)
iptables -vnL                 # listing the filter table (it's default) of all chains, verbose (v) and in numeric format (n) 
iptables -vnL INPUT         ` # listing specific chain whitin  a table 
iptables -t nat -vnL          # listing another table, not filter
iptables -t nat -vnL POSTROUTING  # listing just a CHAIN


# APPEND
iptables -A INPUT -p tcp --dport 80 -j DROP           # append command to the INPUT chain (will be added to the bottom of the chain by default)


# INSERT
iptables -I INPUT -p icmp -j ACCEPT                   # insert rule at the top of the chain (default behavoiur)
iptables -I INPUT -p udp --dport 69 -j DROP           # insert rule at the top of the chain (default behavoiur)
iptables -I INPUT <n> -p icmp -j ACCEPT                 # insert rule at position n of the chain 
iptables -I INPUT 3 -p icmp -j ACCEPT                   # insert rule at position n of the chain 



# FLUSH
iptables -F                                           # flushes all rules in all chains of the default table (filter table)
iptables -F INPUT                                          
iptables -F INPUT  -t nat                


# ZERO
iptables -Z                                            # resets bytes and packets counter 


# N
iptables -N TCP_TRAFFIC                                # creates a user-defined CHAIN
 
# X
iptables -X TCP_TRAFFIC                                # delete a user-defined CHAIN
iptables -X                                            # delete all user definied  chains

# P
iptables -P INPUT ACCEPT                               # sets the default POLICY for a chain when no rules matach a request (ACCEPT/DROP)
iptables -P FORWARD DROP                               # Setting the DROP Policy on FORWARD chain
iptables -P OUTPUT ACCEPT                              # Setting the ACCEPT Policy on OUTPUT chain
iptables -P INPUT DROP                                 # Setting the DROP Policy on INPUT chain



# D
iptables -D OUTPUT 2                                   #  deletes a rule, the rule number must be supplied




=============================
= SAVE e RESTORE
==============================

iptables-save                         # returns iptables rules that are  active(from memory)
iptables-save > my_rules.txt          # write active rules(from memory) into file

iptables-restore my_rules.txt         # load rules into memory




# Persist rules on rebioot - UBUNTU / CENTOS
apt-get install iptables-persistent


Debian/Ubuntu: iptables-save > /etc/iptables/rules.v4
RHEL/CentOS: iptables-save > /etc/sysconfig/iptables

Debian/Ubuntu: ip6tables-save > /etc/iptables/rules.v6
RHEL/CentOS: ip6tables-save > /etc/sysconfig/ip6tables


https://www.thomas-krenn.com/en/wiki/Saving_Iptables_Firewall_Rules_Permanently#:~:text=Since%20Ubuntu%2010.04%20LTS%20(Lucid,v6%20for%20IPv6.





=====================
= BASIC matches
====================
iptables  -A INPUT -s <ip> -j DROP                    # drop incoming traffic from specific IP
iptables  -A INPUT -s <domain> -j DROP                # drop incoming traffic from specific domain, iptables will take care of DNS resolution
iptables  -A INPUT -s <networkSubnet> -j DROP         # drop incoming traffic netowrk subnet
iptables  -A INPUT -s 192.168.1.179 -j DROP           # drop incoming traffic from specific IP



sudo iptables -A OUTPUT -d 8.0.0.0/8 -j DROP           # drop ougoing traffic to the all 8.0.0.0 network, all IPs under that nwtwork



iptables -A OUTPUT -p tcp --dport 443   -j ACCEPT           # implicitly the destination will be all | allow https over ssh to other ips
iptables -A OUTPUT -p tcp --dport 443  -d 0/0 -j ACCEPT     # explictly  defining the destination to all | allow https over ssh to other ips


=============================
= Extras
==============================

sudo apt-get --reinstall install iptables


